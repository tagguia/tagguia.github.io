<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Teste de localização</title>

	<script src="jquery-2.1.3.js"></script>
	<link rel="stylesheet" href="css/main.css">

	<meta name="viewport" content="width=device-width">
</head>
<body id="body">

	<input type="button" value="Me encontre!" class="button">

	<ul>
		<li><label for="cidade"></label><h2 class="city"></h2></li>
		<li><label for="estado"></label><h2 class="state"></h2></li>
	</ul>

	<noscript>
		<form action="query.php" method="post">
			<label for="Cidade">Cidade: </label><input type="text" name="cidade" id="city">
			<label for="Estado">Estado: </label><input type="text" name="estado" id="state">
			<input type="submit" value="Enviar">
		</form>
	</noscript>


	<script>
	(function() {
		if('geolocation' in navigator){

			function returnResult(arrReturn){
				var cityStateCountry = arrReturn.split(", ");
				var cep = arrReturn.split(" - ");
				var city = cityStateCountry[0];
				var state = cityStateCountry[1];
				var country = cityStateCountry[2];

				var h2City = document.querySelector('.city');
				var h2State = document.querySelector('.state');

				h2City.innerHTML = city;					
				h2State.innerHTML = state;

				console.log(cep);
			}	

			function findMe(){
				navigator.geolocation.getCurrentPosition(function(geo){
					var latitude = geo.coords.latitude;
					var longitude = geo.coords.longitude;

					var url = "http://maps.googleapis.com/maps/api/geocode/json?latlng="+latitude+","+longitude+"&sensor=true";

					$.ajax({
						url: url,
						cashe: false,
						dataType: "json",
						beforeSend: function(){
							console.log("carregando");
						},
						error: function(){
							console.log("ocorreu um erro");
						},
						success: function(retorno){
									if(retorno.erro){
										console.log(retorno.erro);
									} else {
										var result = retorno['results'][3].formatted_address;
										
										returnResult(result);

									}
								}
					});

				});				
			}


			var button = document.querySelector('.button');
			button.addEventListener('click', findMe, false);
			
		} else {
			var form = "<form action='query.php' method='post'><label for='cidade'>Cidade: </label><input type='text' name='city' id='' /><label for='estado'>Estado: </label><input type='text' name='state' id='' /><input type='submit' value='Enviar' /></form>";
			var body = document.querySelector('body');

			body.innerHTML += form;
		}	

	}());
	</script>
	
</body>
</html>